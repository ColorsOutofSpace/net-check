# 开发规范

本文档用于统一 Net Check 的开发方式，降低协作成本，确保“快速定位网络不可用问题”的产品目标不偏移。

## 1. 目标与原则

- 目标：优先帮助开发者在最短时间内定位网络故障根因。
- 原则一：先保证稳定与可解释，再扩展功能。
- 原则二：实现保持精简，避免过度重试、冗余判断和复杂分支。
- 原则三：所有诊断结论必须可追溯到命令输出证据。

## 2. 仓库结构职责

- `apps/web`：前端交互与可视化展示，不负责实际系统命令执行。
- `apps/server`：命令白名单执行、任务流、解析与诊断。
- `docs`：架构、贡献流程、开发规范文档。

禁止跨层职责扩散，例如在前端拼接或执行系统命令。

## 3. 开发流程

1. 明确需求范围与验收标准（功能、风险、回归点）。
2. 先改类型与数据模型，再改实现逻辑，再改展示层。
3. 完成后执行本地校验：
   - `npm run lint`
   - 必要时 `npm run build`
4. 更新文档（README/架构/贡献或本规范）。

## 4. 代码风格

- 语言：TypeScript。
- 缩进：2 空格。
- 命名：
  - 组件使用 `PascalCase`。
  - 变量、函数使用 `camelCase`。
  - 文件名语义化，例如 `job-manager.ts`、`parsers.ts`。
- 注释：
  - 仅在复杂逻辑前添加简短注释。
  - 禁止“解释显而易见代码”的冗余注释。

## 5. 网络检测项开发规范

新增检测项时，必须按以下顺序实现：

1. 在 `apps/server/src/diagnostics/definitions.ts` 添加白名单命令定义。
2. 对不支持的平台返回 `UNSUPPORTED_PLATFORM` 占位输出。
3. 在 `apps/server/src/diagnostics/parsers.ts` 添加解析逻辑。
4. 产出统一结果：
   - `structured`：结构化字段（机器可读）
   - `diagnosis`：诊断建议（用户可读）
   - `evidence`：证据链（用于总览矩阵与根因展示）
5. 确保任务结束后 `JobSnapshot` 可返回完整结果。

要求：
- 不执行任何未在 `definitions.ts` 声明的命令。
- 不拼接执行用户原始 shell 输入。
- 默认命令需有超时兜底，避免流程卡死。

## 6. 一键检测与并发规范

- 一键检测必须支持并行执行，单项失败不能阻塞全流程。
- 并发数应可配置，并限制在合理范围内（避免资源争抢）。
- 输出顺序允许交错，但每条输出必须带可识别的检测项上下文。

## 7. 前端展示规范

- 总览页优先展示“结论 + 证据”，避免仅展示抽象状态。
- 实时输出保留原始日志，不做过度加工。
- 异常判断规则需尽量基于结构化字段，减少关键词误判。
- 对“未命中问题”的情况给出明确文案，不显示误告警。

## 8. 质量与测试规范

- 提交前至少通过 `npm run lint`。
- 涉及以下变更时需补充测试或手工验证记录：
  - 解析规则改动（parser）
  - 一键并发流程改动
  - SSE 事件时序改动
  - 编码/乱码处理改动
- 测试应尽量确定性，避免依赖不稳定公网状态。

## 9. 提交与评审规范

- Commit 使用 Conventional Commits，例如：
  - `feat: add gateway arp check parser`
  - `fix: avoid adapter false warning when no adapter parsed`
- PR 描述应包含：
  - 变更目的
  - 关键改动点
  - 验证方式与结果
  - 风险与回滚点

## 10. 安全与隐私规范

- 仅允许白名单命令执行。
- API 输入必须校验与约束。
- 输出日志默认视为可能包含敏感网络信息，避免长期明文存储。
- 涉及代理账号、令牌等信息时需脱敏展示。

## 11. 文档维护规范

- 行为变更影响用户使用方式时，必须同步更新 `README.md`。
- 架构或数据流调整时，必须同步更新 `docs/architecture.md`。
- 协作流程调整时，必须同步更新 `docs/contribution.md`。

